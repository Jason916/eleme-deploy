{{ include('deploy/header.twig') }}

<div class="row">
    <div class="panel panel-default">
        <div class="panel-heading">Branch Deploy</div>
        <div class="panel-body">
            <form class="form-inline" role="form" action="/deploy/branch" method="post">
                <div class="form-group form-group-sm">
                    <label class="control-label" for="branch">Branch Name</label>
                    <input class="form-control input-sm" id="branch" name="branch" placeholder="Branch Name" value="{{ default_branch }}">
                </div>
                <div class="form-group">
                    <button type="submit" id="deployBranch" class="btn btn-sm btn-info">Deploy</button>
                </div>
            </form>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">Commit Deploy</div>
        <div class="panel-body">
            <form class="form-inline" role="form" action="/deploy/commit" method="post">
                <div class="form-group form-group-sm">
                    <label class="sr-only" for="commit">Commit Version</label>
                    <select class="form-control input-sm" id="s-commit" name="commit">
                        <option value="">Commit Version...</option>
                        {% for ch in commit_version %}
                        <option value="{{ ch[0] }}">{{ ch[0] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group form-group-sm">
                    <label class="sr-only" for="remote">remote</label>
                    <select class="form-control input-sm" id="remote" name="remote">
                        <option value="staging">Staging</option>
                        <option value="production">Production</option>
                    </select>
                </div>
                <div class="form-group form-group-sm">
                    <button type="submit" id="deployCommit" class="btn btn-sm btn-info">Deploy</button>
                </div>
            </form>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">Deploy List</div>
        <div class="panel-body">
            <table class="table table-striped table-hover table-deploy-list">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Branch</th>
                    <th>Commit Version</th>
                    <th>Deploy Type</th>
                    <th>Host Type</th>
                    <th>Deploy Time</th>
                    <th>Last Update</th>
                    <th>Result</th>
                </tr>
                </thead>
                <tbody>
                {% for m in results %}
                <tr {{ m.result=='success' ? 'class="text-success"' : 'class="text-warning"' }} data-result="{{ m.result }}" data-id="{{ m.id }}">
                    <td>{{ m.id }}</td>
                    <td>{{ m.branch }}</td>
                    <td>{{ m.commit }}</td>
                    <td>{{ m.type }}</td>
                    <td>{{ m.hosttype }}</td>
                    <td>{{ m.time }}</td>
                    <td>{{ m.last_time }}</td>
                    <td>{{ m.result }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
$(function() {
    var resultInterval = window.setInterval(function () {
        var result = $(".table-deploy-list tbody tr:first").attr('data-result');
        var id = $(".table-deploy-list tbody tr:first").attr('data-id');
        if (result == 'success' || id == '') {
            return ;
        }

        if (result != 'success') {
            $.getJSON('/deploy/status?id=' + id, function (data) {
                if (data.res == 0) {
                    $(".table-deploy-list tbody tr:first").attr('data-result', data.result);
                    $(".table-deploy-list tbody tr:first td:last").html(data.result);
                    $(".table-deploy-list tbody tr:first td:eq(2)").html(data.commit);
                    $(".table-deploy-list tbody tr:first td:eq(6)").html(data.last_time);
                    if (data.result == 'success') {
                        $(".table-deploy-list tbody tr:first").attr('class', 'text-success');
                    }
                }
            });
        }

    }, 4000);
});
</script>

{{ include('deploy/footer.twig') }}

